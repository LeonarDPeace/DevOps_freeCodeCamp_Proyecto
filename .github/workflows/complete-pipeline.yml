# Pipeline completo automÃ¡tico - Se ejecuta en cada push a main
name: Complete CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '**/Dockerfile'
      - 'package*.json'
  workflow_dispatch:  # TambiÃ©n permite ejecuciÃ³n manual
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      skip_tests:
        description: 'Saltar tests?'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci --prefer-offline
      
      - name: Run Backend Tests
        working-directory: ./backend
        run: npm test --if-present
        continue-on-error: true
      
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci --prefer-offline
      
      - name: Run Frontend Tests
        working-directory: ./frontend
        run: npm test --if-present
        continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to ${{ inputs.environment }}
        run: |
          echo "Deploying to ${{ inputs.environment }} environment"
          echo "Would trigger deployment to Render here"
          # curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      
      - name: Health Check
        run: |
          echo "Performing health check..."
          # curl -f https://your-app.onrender.com/health || exit 1
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests skipped: ${{ inputs.skip_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
